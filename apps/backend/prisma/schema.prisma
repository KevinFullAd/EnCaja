enum PrintStatus {
  PENDING
  OK
  ERROR
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * CATALOGO
 * =========================
 */

model Category {
  id        String   @id @default(cuid())
  slug      String   @unique
  name      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  families ProductFamily[]
}

model ProductFamily {
  id         String   @id @default(cuid())
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  slug      String  @unique
  name      String
  imageUrl  String?
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  flavors ProductFlavor[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
}

model ProductFlavor {
  id       String        @id @default(cuid())
  familyId String
  family   ProductFamily @relation(fields: [familyId], references: [id], onDelete: Cascade)

  slug        String
  nameSuffix  String  @default("") // "con nachos"
  description String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  variants ProductVariant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([familyId, slug])
  @@index([familyId])
}

model ProductVariant {
  id       String        @id @default(cuid())
  flavorId String
  flavor   ProductFlavor @relation(fields: [flavorId], references: [id], onDelete: Cascade)

  slug       String // simple|doble|triple|unit 
  label      String  @default("") // "Simple"
  priceCents Int
  currency   String  @default("ARS")
  imageUrl   String?
  sortOrder  Int     @default(0)
  isActive   Boolean @default(true)

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  orderItems OrderItem[]

  @@unique([flavorId, slug])
  @@index([flavorId])
}

/**
 * =========================
 * USUARIOS / ORDENES
 * =========================
 */

model User {
  id          String   @id @default(cuid())
  displayName String
  role        UserRole @default(OPERARIO)
  pinHash     String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ordersCreated     Order[]         @relation("OrderCreatedBy")
  ordersVoided      Order[]         @relation("OrderVoidedBy")
  ordersLastPrinted Order[]         @relation("OrderLastPrintedBy")
  orderPrintLogs    OrderPrintLog[]
}

enum UserRole {
  OPERARIO
  ADMIN
}

model Order {
  id          String   @id @default(cuid())
  orderNumber Int
  createdAt   DateTime @default(now())

  createdByUserId String
  createdByUser   User   @relation("OrderCreatedBy", fields: [createdByUserId], references: [id])

  notes String?
  total Int     @default(0)

  printedAt           DateTime?
  printStatus         PrintStatus @default(PENDING)
  printerName         String?
  printError          String?
  lastPrintedByUserId String?
  lastPrintedByUser   User?       @relation("OrderLastPrintedBy", fields: [lastPrintedByUserId], references: [id])

  isVoided       Boolean   @default(false)
  voidedByUserId String?
  voidedByUser   User?     @relation("OrderVoidedBy", fields: [voidedByUserId], references: [id])
  voidedAt       DateTime?
  voidReason     String?

  items          OrderItem[]
  orderPrintLogs OrderPrintLog[]

  @@unique([orderNumber])
  @@index([createdAt])
  @@index([createdByUserId])
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Ahora el item apunta a la variante vendible
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  // Snapshot (se mantiene el enfoque)
  itemNameSnapshot  String
  unitPriceSnapshot Int
  quantity          Int
  subtotalSnapshot  Int
  notes             String?

  @@index([orderId])
  @@index([variantId])
}

model OrderPrintLog {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  success      Boolean
  printerName  String?
  errorMessage String?
  printedAt    DateTime @default(now())

  performedByUserId String
  performedByUser   User   @relation(fields: [performedByUserId], references: [id])

  @@index([orderId])
  @@index([printedAt])
}
